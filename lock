--// Camlock with Auto Predict (WalkSpeed + Ping) + Red Dot Marker
local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

local camlockOn = false
local holdingRMB = false
local allowSlot = false
local target = nil
local marker = nil -- BillboardGui

-- Helper
local function valid(plr)
    if not plr or plr == LocalPlayer then return false end
    local char = plr.Character
    if not char then return false end
    local hum = char:FindFirstChildOfClass("Humanoid")
    local head = char:FindFirstChild("Head")
    return hum and hum.Health > 0 and head ~= nil
end

-- Lấy ping (giây)
local function getPing()
    local stats = game:GetService("Stats")
    local pingValue = stats.Network.ServerStatsItem["Data Ping"]:GetValue() or 0
    return pingValue / 1000
end

-- Predict time = walkspeed + ping
local function getPredictTime(hum)
    local base = 0.1
    if hum and hum.WalkSpeed then
        base = math.clamp(hum.WalkSpeed / 200, 0.05, 0.25)
    end
    return base + getPing()
end

-- Marker (chấm đỏ)
local function addMarker(head)
    if marker then marker:Destroy() end
    marker = Instance.new("BillboardGui")
    marker.Size = UDim2.new(0,6,0,6)
    marker.AlwaysOnTop = true
    marker.Adornee = head
    local dot = Instance.new("Frame")
    dot.Size = UDim2.new(1,0,1,0)
    dot.BackgroundColor3 = Color3.new(1,0,0)
    dot.BorderSizePixel = 0
    dot.AnchorPoint = Vector2.new(0.5,0.5)
    dot.Position = UDim2.new(0.5,0,0.5,0)
    dot.Parent = marker
    marker.Parent = head
end

local function removeMarker()
    if marker then
        marker:Destroy()
        marker = nil
    end
end

-- Player
local function closestToMouse()
    local best, bestDist = nil, math.huge
    local mousePos = UIS:GetMouseLocation() - Vector2.new(0,36)
    for _, plr in ipairs(Players:GetPlayers()) do
        if valid(plr) then
            local head = plr.Character.Head
            local vp, onScreen = Camera:WorldToViewportPoint(head.Position)
            if onScreen then
                local d = (Vector2.new(vp.X,vp.Y) - mousePos).Magnitude
                if d < bestDist then
                    bestDist = d
                    best = plr
                end
            end
        end
    end
    return best
end

-- Check tool
local function holdingTool()
    return LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Tool") ~= nil
end

-- Input
UIS.InputBegan:Connect(function(input,gpe)
    if input.UserInputType == Enum.UserInputType.MouseButton2 then
        holdingRMB = true
        return
    end
    if gpe then return end

    if input.KeyCode == Enum.KeyCode.Q then
        if camlockOn then
            camlockOn = false
            target = nil
            removeMarker()
        else
            target = closestToMouse()
            if target then
                camlockOn = true
                addMarker(target.Character.Head)
            end
        end
    elseif input.KeyCode == Enum.KeyCode.One
        or input.KeyCode == Enum.KeyCode.Two
        or input.KeyCode == Enum.KeyCode.Three then
        allowSlot = true
    elseif input.KeyCode == Enum.KeyCode.Four
        or input.KeyCode == Enum.KeyCode.Five
        or input.KeyCode == Enum.KeyCode.Six
        or input.KeyCode == Enum.KeyCode.Seven
        or input.KeyCode == Enum.KeyCode.Eight
        or input.KeyCode == Enum.KeyCode.Nine
        or input.KeyCode == Enum.KeyCode.Zero then
        allowSlot = false
    end
end)

UIS.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton2 then
        holdingRMB = false
    end
end)

-- Loop
RunService.RenderStepped:Connect(function()
    if target and not valid(target) then
        target = nil
        camlockOn = false
        removeMarker()
        return
    end

    if camlockOn and holdingRMB and allowSlot and holdingTool() and target then
        local head = target.Character:FindFirstChild("Head")
        local hrp = target.Character:FindFirstChild("HumanoidRootPart")
        local hum = target.Character:FindFirstChildOfClass("Humanoid")

        if head and hrp and hum then
            local predictTime = getPredictTime(hum)
            local predicted = head.Position + (hrp.Velocity * predictTime)
            Camera.CFrame = CFrame.new(Camera.CFrame.Position, predicted)
        end
    end
end)
